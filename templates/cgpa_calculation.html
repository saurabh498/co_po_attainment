<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGPA Calculation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Arial', sans-serif;
    }

    .container {
      max-width: 900px;
      margin-top: 20px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #007bff;
      color: white;
    }

    input {
      width: 50px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }

    .btn-custom {
      background-color: #28a745;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn-custom:hover {
      background-color: #218838;
    }

    .card {
      padding: 15px;
      border-radius: 8px;
      background: #e9ecef;
    }

    #cgpa-box {
      font-size: 22px;
      font-weight: bold;
      color: #dc3545;
    }
  </style>

</head>

<body>
  <div class="container mt-4">
    <h1 class="text-center">CGPA Calculation</h1>
    <div class="d-flex justify-content-between">
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <div class="card p-3 shadow mt-3">
      <h4 class="text-center">Selected Student</h4>
      <p><strong>Roll No:</strong> <span id="student-roll"></span></p>
      <p><strong>Full Name:</strong> <span id="student-name"></span></p>
    </div>

    <div class="table-responsive mt-3">
      <table>
        <tr>
          <th colspan="6">Q1</th>
          <th colspan="2">Q2</th>
          <th colspan="2">Q3</th>
          <th>Total UT 1 (20 M)</th>
        </tr>
        <tr>
          <td>a</td>
          <td>b</td>
          <td>c</td>
          <td>d</td>
          <td>e</td>
          <td>f</td>
          <td>a</td>
          <td>b</td>
          <td>a</td>
          <td>b</td>
          <td class="totalUT1">0</td>
        </tr>
        <tr>
          <td colspan="10">CO Mapping</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
      </table>
    </div>

    <div class="table-responsive mt-3">
      <table>
        <tr>
          <th colspan="6">Q1</th>
          <th colspan="2">Q2</th>
          <th colspan="2">Q3</th>
          <th>Total UT 2 (20 M)</th>
        </tr>
        <tr>
          <td>a</td>
          <td>b</td>
          <td>c</td>
          <td>d</td>
          <td>e</td>
          <td>f</td>
          <td>a</td>
          <td>b</td>
          <td>a</td>
          <td>b</td>
          <td class="totalUT1">0</td>
        </tr>
        <tr>
          <td colspan="10">CO Mapping</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
      </table>
    </div>


    <div class="text-center mt-4">
      <table class="table-bordered">
        <tr>
          <th>Avg Unit Test Marks (Out of 20)</th>
        </tr>
        <tr>
          <td id="avgMarks">0</td>
        </tr>
      </table>
      <div class="btn-group mt-3">
        <button class="btn btn-primary" onclick="CalculateMarks()">Calculate Marks</button>
      </div>
    </div>

    <div class="row mt-4 text-center">
      <div class="col-md-4">
        <table class="table-bordered">
          <tr>
            <th>External Examination (Total 80 Marks)</th>
          </tr>
          <tr>
            <td><input type="number" id="externalMarks" min="0" max="80"></td>
          </tr>
        </table>
      </div>
      <div class="col-md-4">
        <table class="table-bordered">
          <tr>
            <th>Orals (Total 25 Marks)</th>
          </tr>
          <tr>
            <td><input type="number" id="oralMarks" min="0" max="25"></td>
          </tr>
        </table>
      </div>
      <div class="col-md-4">
        <table class="table-bordered">
          <tr>
            <th>Term Work (Total 25 Marks)</th>
          </tr>
          <tr>
            <td><input type="number" id="termWorkMarks" min="0" max="25"></td>
          </tr>
        </table>
      </div>

      <div class="text-center mt-4">
        <button class="btn btn-success" onclick="CalculateCGPA()">Calculate CGPA</button>
        <button class="btn btn-warning" onclick="SaveData()">Save</button>
        <button class="btn btn-secondary" onclick="course_exit_analysis()">Next</button>
      </div>

      <!-- CGPA Message Display -->
      <div id="cgpa-message" class="text-center mt-3" style="font-size: 20px; font-weight: bold; color: #dc3545;">
        <p><strong>Calculated CGPA: </strong><span id="cgpa-box">0</span></p>

      </div>

    </div>


    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let rollNo = sessionStorage.getItem("selected_roll_no");
        let fullName = sessionStorage.getItem("selected_name");

        if (!rollNo || !fullName) {
          alert("No student selected!");
          window.location.href = "/";
          return;
        }

        document.getElementById("student-roll").innerText = rollNo;
        document.getElementById("student-name").innerText = fullName;
      });

      async function CalculateMarks() {
        let totalUT1 = 0, totalUT2 = 0;
        let valid = true;

        // Select only the rows with marks inputs (skip "CO Mapping" rows)
        let ut1Inputs = document.querySelectorAll("table:nth-of-type(1) tr:nth-child(4) input, table:nth-of-type(1) tr:nth-child(5) input");
        let ut2Inputs = document.querySelectorAll("table:nth-of-type(2) tr:nth-child(4) input, table:nth-of-type(2) tr:nth-child(5) input");

        // Function to validate and sum marks
        function validateAndSum(inputs) {
          let total = 0;
          inputs.forEach((input, index) => {
            let value = parseFloat(input.value) || 0;
            let maxMarks = 0;

            // Define max marks based on question number
            if (index % 10 < 6) maxMarks = 2;  // Q1 (a-f) → Max 2 marks
            else if (index % 10 < 8) maxMarks = 5; // Q2 (a, b) → Max 5 marks
            else if (index % 10 < 10) maxMarks = 5; // Q3 (a, b) → Max 5 marks

            // Validation
            if (value > maxMarks) {
              alert(`Q${index % 10 < 6 ? 1 : index % 10 < 8 ? 2 : 3} Column ${String.fromCharCode(97 + (index % 10))} cannot be more than ${maxMarks} marks.`);
              input.value = maxMarks;
              valid = false;
            }
            total += value;
          });
          return total;
        }

        // Validate and calculate totals
        totalUT1 = validateAndSum(ut1Inputs);
        totalUT2 = validateAndSum(ut2Inputs);

        // Update total marks in the table
        document.querySelectorAll(".totalUT1").forEach(cell => cell.innerText = totalUT1);
        document.querySelectorAll(".totalUT2").forEach(cell => cell.innerText = totalUT2);

        // Update average marks
        if (valid) {
          let avgMarks = (totalUT1 + totalUT2) / 2;
          document.getElementById("avgMarks").innerText = avgMarks.toFixed(2);
        }
      }

      function CalculateCGPA() {
        let avgMarks = parseFloat(document.getElementById("avgMarks").innerText) || 0;
        let externalMarks = parseFloat(document.getElementById("externalMarks").value) || 0;
        let oralMarks = parseFloat(document.getElementById("oralMarks").value) || 0;
        let termWorkMarks = parseFloat(document.getElementById("termWorkMarks").value) || 0;

        let totalMarks = avgMarks + externalMarks + oralMarks + termWorkMarks;

        // Assuming max total marks is 150, normalize to a 10-point scale
        let cgpa = (totalMarks / 150) * 10;
        if (cgpa > 10) cgpa = 10; // Ensuring CGPA doesn't exceed 10

        // ✅ Corrected: Update `cgpa-box` instead of a missing `cgpa`
        document.getElementById("cgpa-box").innerText = cgpa.toFixed(2);

        // ✅ Update the CGPA message display
        document.getElementById("cgpa-message").innerHTML = `CGPA is: <span style="color: #007bff; font-weight: bold;">${cgpa.toFixed(2)}</span>`;
      }


      function SaveData() {
    let rollElement = document.getElementById("student-roll");
    let nameElement = document.getElementById("student-name");
    let avgMarksElement = document.getElementById("avgMarks");
    let externalElement = document.getElementById("externalMarks");
    let oralElement = document.getElementById("oralMarks");
    let termWorkElement = document.getElementById("termWorkMarks");

    // Ensure required elements exist
    if (!rollElement || !nameElement || !avgMarksElement ||
        !externalElement || !oralElement || !termWorkElement) {
        console.error("One or more elements are missing in the HTML!");
        alert("Error: Some required fields are missing!");
        return;
    }

    // Collect Student Data
    let studentData = {
        student_id: parseInt(rollElement.innerText.trim()) || 0,
        avg_unit_test_marks: parseFloat(avgMarksElement.innerText) || 0,
        external_exam: parseInt(externalElement.value) || 0,
        orals: parseInt(oralElement.value) || 0,
        term_work: parseInt(termWorkElement.value) || 0,
        cgpa: 0.0,  // Placeholder, calculated in backend

        // Collect Unit Test Marks
        unit_test_marks: collectUnitTestMarks(),

        // Collect CO Mapping Data
        co_mapping: collectCOMapping()
    };

    console.log("Sending Data:", JSON.stringify(studentData, null, 2)); // Debugging log

    // Send Data to Backend
    fetch("/save_data", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(studentData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            alert("Success: " + data.message);
        }
    })
    .catch(error => console.error("Error:", error));
}

// Function to Collect Unit Test Marks
function collectUnitTestMarks() {
    let unitTestData = [];
    let unitTests = document.querySelectorAll(".unit-test-input");

    unitTests.forEach(input => {
        let unitTestNumber = input.getAttribute("data-ut");  // Use getAttribute instead of dataset
        let questionNumber = input.getAttribute("data-qn");
        let marks = parseInt(input.value) || 0;

        if (unitTestNumber && questionNumber) {
            unitTestData.push({
                unit_test_number: parseInt(unitTestNumber),
                question_number: questionNumber,
                marks: marks
            });
        }
    });

    console.log("Unit Test Marks:", unitTestData); // Debugging log
    return unitTestData;
}

// Function to Collect CO Mapping Data
function collectCOMapping() {
    let coMappingData = [];
    let coInputs = document.querySelectorAll(".co-mapping-input");

    coInputs.forEach(input => {
        let unitTestNumber = input.getAttribute("data-ut");
        let questionNumber = input.getAttribute("data-qn");
        let coValue = input.value.trim();

        if (unitTestNumber && questionNumber) {
            coMappingData.push({
                unit_test_number: parseInt(unitTestNumber),
                question_number: questionNumber,
                co_value: coValue
            });
        }
    });

    console.log("CO Mapping Data:", coMappingData); // Debugging log
    return coMappingData;
}


function course_exit_analysis() {
    let rollNo = sessionStorage.getItem("selected_roll_no");
    if (rollNo) {
        window.location.href = "/course_exit_analysis?roll_no=" + encodeURIComponent(rollNo);
    } else {
        alert("No student selected!");
    }
}


      function logout() {
        sessionStorage.clear();
        window.location.href = "/login";
      }
    </script>
</body>

</html>