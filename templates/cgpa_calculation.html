<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CGPA Calculation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      height: 3000px;
    }

    table {
      width: auto;
      /* Prevents excessive stretching */
      border-collapse: collapse;
      margin: 10px;
      font-size: 12px;
      text-align: center;
      display: inline-block;
      vertical-align: top;
    }

    th,
    td {
      border: 1px solid black;
      padding: 5px;
    }

    th {
      background-color: #f2f2f2;
    }

    input {
      width: 30px;
      text-align: center;
      font-size: 10px;
      padding: 2px;
    }

    /* Fix alignment for button & table */
    .button-table-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    button {
      background-color: gold;
      padding: 8px 12px;
      border: none;
      cursor: pointer;
      font-weight: bold;
    }
  </style>


</head>

<body>
  <div class="container mt-4">
    <h1 class="text-center">CGPA Calculation</h1>
    <div class="d-flex justify-content-between align-items-center">
      <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <div class="card p-3 shadow mt-3">
      <h4 class="text-center mb-2">Selected Student</h4>
      <p><strong>Roll No:</strong> <span id="student-roll"></span></p>
      <p><strong>Full Name:</strong> <span id="student-name"></span></p>
    </div>

    <div class="d-flex justify-content-center">
      <table>
        <tr>
          <th colspan="6">Q1</th>
          <th colspan="2">Q2</th>
          <th colspan="2">Q3</th>
          <th>Total UT 1 (20 M)</th>
        </tr>
        <tr>
          <td>a</td>
          <td>b</td>
          <td>c</td>
          <td>d</td>
          <td>e</td>
          <td>f</td>
          <td>a</td>
          <td>b</td>
          <td>a</td>
          <td>b</td>
          <td class="totalUT1">0</td>
        </tr>
        <tr>
          <td colspan="10">CO Mapping</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td class="totalUT1">0</td>
        </tr>
      </table>

      <table>
        <tr>
          <th colspan="6">Q1</th>
          <th colspan="2">Q2</th>
          <th colspan="2">Q3</th>
          <th>Total UT 2 (20 M)</th>
        </tr>
        <tr>
          <td>a</td>
          <td>b</td>
          <td>c</td>
          <td>d</td>
          <td>e</td>
          <td>f</td>
          <td>a</td>
          <td>b</td>
          <td>a</td>
          <td>b</td>
          <td class="totalUT2">0</td>
        </tr>
        <tr>
          <td colspan="10">CO Mapping</td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td></td>
        </tr>
        <tr>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td><input type="text"></td>
          <td class="totalUT2">0</td>
        </tr>
      </table>
      
      <div style="text-align: center; margin-top: 20px;">
        <div style="display: inline-block; text-align: center;">
          <table style="border: 1px solid black; border-collapse: collapse; font-size: 14px; width: 160px;">
            <tr>
              <th style="border: 1px solid black; padding: 5px;">Avg Unit Test Marks (Out of 20)</th>
            </tr>
            <tr>
              <td id="avgMarks" style="border: 1px solid black; padding: 5px; text-align: center;">0</td>
            </tr>
          </table>
          <br>
          <button onclick="CalculateMarks()">Calculate Marks</button>
        </div>
      </div>
    </div>


    <div style="display: flex; justify-content: center; gap: 20px; margin-top: 20px;">
      <table border="1" style="border-collapse: collapse; width: 17%; text-align: center;">
        <tr>
          <th>External Examination (Total 80 Marks)</th>
        </tr>
        <tr>
          <td><input type="number" id="externalMarks" min="0" max="80" style="width: 90%; text-align: center;"></td>
        </tr>
      </table>

      <table border="1" style="border-collapse: collapse; width: 10%; text-align: center;">
        <tr>
          <th>Orals (Total 25 Marks)</th>
        </tr>
        <tr>
          <td><input type="number" id="oralMarks" min="0" max="25" style="width: 90%; text-align: center;"></td>
        </tr>
      </table>

      <table border="1" style="border-collapse: collapse; width: 10%; text-align: center;">
        <tr>
          <th>Term Work (Total 25 Marks)</th>
        </tr>
        <tr>
          <td><input type="number" id="termWorkMarks" min="0" max="25" style="width: 90%; text-align: center;"></td>
        </tr>
      </table>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let rollNo = sessionStorage.getItem("selected_roll_no");
        let fullName = sessionStorage.getItem("selected_name");

        if (!rollNo || !fullName) {
          alert("No student selected!");
          window.location.href = "/";
          return;
        }

        document.getElementById("student-roll").innerText = rollNo;
        document.getElementById("student-name").innerText = fullName;
      });

      async function CalculateMarks() {
        let totalUT1 = 0, totalUT2 = 0;
        let valid = true;

        // Select only the rows with marks inputs (skip "CO Mapping" rows)
        let ut1Inputs = document.querySelectorAll("table:nth-of-type(1) tr:nth-child(4) input, table:nth-of-type(1) tr:nth-child(5) input");
        let ut2Inputs = document.querySelectorAll("table:nth-of-type(2) tr:nth-child(4) input, table:nth-of-type(2) tr:nth-child(5) input");

        // Function to validate and sum marks
        function validateAndSum(inputs) {
          let total = 0;
          inputs.forEach((input, index) => {
            let value = parseFloat(input.value) || 0;
            let maxMarks = 0;

            // Define max marks based on question number
            if (index % 10 < 6) maxMarks = 2;  // Q1 (a-f) → Max 2 marks
            else if (index % 10 < 8) maxMarks = 5; // Q2 (a, b) → Max 5 marks
            else if (index % 10 < 10) maxMarks = 5; // Q3 (a, b) → Max 5 marks

            // Validation
            if (value > maxMarks) {
              alert(`Q${ index % 10 < 6 ? 1 : index % 10 < 8 ? 2 : 3} Column ${ String.fromCharCode(97 + (index % 10)) } cannot be more than ${ maxMarks } marks.`);
              input.value = maxMarks;
              valid = false;
            }
            total += value;
          });
          return total;
        }

        // Validate and calculate totals
        totalUT1 = validateAndSum(ut1Inputs);
        totalUT2 = validateAndSum(ut2Inputs);

        // Update total marks in the table
        document.querySelectorAll(".totalUT1").forEach(cell => cell.innerText = totalUT1);
        document.querySelectorAll(".totalUT2").forEach(cell => cell.innerText = totalUT2);

        // Update average marks
        if (valid) {
          let avgMarks = (totalUT1 + totalUT2) / 2;
          document.getElementById("avgMarks").innerText = avgMarks.toFixed(2);
        }
      }

      function logout() {
        sessionStorage.clear();
        window.location.href = "/login";
      }
    </script>
</body>

</html>
