<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Outcome Attainment Calculation</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }

        h2 {
            color: #333;
            margin-top: 20px;
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: white;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #e8f0ff;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calculate-btn {
            background: #28a745;
            color: white;
        }

        .reset-btn {
            background: #dc3545;
            color: white;
        }

        .next-btn {
            background: #007bff;
            color: white;
        }

        button:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .attainment-3 {
            background-color: #28a745;
            color: white;
        }

        .attainment-2 {
            background-color: #ffc107;
            color: black;
        }

        .attainment-1 {
            background-color: #dc3545;
            color: white;
        }

        .final-attainment {
            font-weight: bold;
        }

        .table-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        input[type="text"] {
            width: 60px;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <table>
            <h2>Course Outcome Attainment Calculation</h2>
            <caption>A. Level of Attainments</caption>
            <thead>
                <tr>
                    <th rowspan="2">Level</th>
                    <th colspan="2">SEE (%)</th>
                    <th colspan="2">CIE (%)</th>
                    <th colspan="2">CES</th>
                </tr>
                <tr>
                    <th class="highlight">></th>
                    <th class="highlight"><=</th>
                    <th class="highlight">></th>
                    <th class="highlight"><=</th>
                    <th class="highlight">></th>
                    <th class="highlight"><=</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="highlight">1</td>
                    <td class="highlight">10</td>
                    <td class="highlight">49</td>
                    <td class="highlight">10</td>
                    <td class="highlight">49</td>
                    <td class="highlight">75</td>
                    <td class="highlight">80</td>
                </tr>
                <tr>
                    <td class="highlight">2</td>
                    <td class="highlight">50</td>
                    <td class="highlight">74</td>
                    <td class="highlight">50</td>
                    <td class="highlight">74</td>
                    <td class="highlight">80</td>
                    <td class="highlight">85</td>
                </tr>
                <tr>
                    <td class="highlight">3</td>
                    <td class="highlight">75</td>
                    <td class="highlight">100</td>
                    <td class="highlight">75</td>
                    <td class="highlight">100</td>
                    <td class="highlight">85</td>
                    <td class="highlight">100</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="container">
        <table>
            <h3>B. Direct / Indirect Attainment Calculation by SEE, CIE and CES</h3>
            <caption>SEE (Direct Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>SEE (%)</th>
                <th>Atn (X)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
        </table>

        <table>
            <caption>CIE (Direct Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>UT AVG</th>
                <th>Atn (Y)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
        </table>

        <table>
            <caption>CES (Indirect Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>AVG</th>
                <th>Atn (Z)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" /></td>
                <td><input type="text" /></td>
            </tr>
        </table>
    </div>

    <div class="container">
        <table id="attainmentTable">
            <caption>D. Final Course Outcome Attainment Calculation: 0.9(0.8X+0.2Y)+0.1(Z)</caption>
            <thead>
                <tr>
                    <th>Course Outcome</th>
                    <th>Total Ext (%)<br>Attainment</th>
                    <th>Total Int (%)<br>Attainment</th>
                    <th>Wt.Avg Max Percentage (%)<br>Attainment</th>
                    <th>Final Attainment</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>CSC305.1</td>
                    <td id="totalExtCSC305.1">-</td>
                    <td id="totalIntCSC305.1">-</td>
                    <td id="wtAvgCSC305.1">-</td>
                    <td id="finalCSC305.1" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.2</td>
                    <td id="totalExtCSC305.2">-</td>
                    <td id="totalIntCSC305.2">-</td>
                    <td id="wtAvgCSC305.2">-</td>
                    <td id="finalCSC305.2" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.3</td>
                    <td id="totalExtCSC305.3">-</td>
                    <td id="totalIntCSC305.3">-</td>
                    <td id="wtAvgCSC305.3">-</td>
                    <td id="finalCSC305.3" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.4</td>
                    <td id="totalExtCSC305.4">-</td>
                    <td id="totalIntCSC305.4">-</td>
                    <td id="wtAvgCSC305.4">-</td>
                    <td id="finalCSC305.4" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.5</td>
                    <td id="totalExtCSC305.5">-</td>
                    <td id="totalIntCSC305.5">-</td>
                    <td id="wtAvgCSC305.5">-</td>
                    <td id="finalCSC305.5" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.6</td>
                    <td id="totalExtCSC305.6">-</td>
                    <td id="totalIntCSC305.6">-</td>
                    <td id="wtAvgCSC305.6">-</td>
                    <td id="finalCSC305.6" class="final-attainment">-</td>
                </tr>
            </tbody>
        </table>

        <div class="buttons">
            <button class="calculate-btn" onclick="calculateFinalAttainment()">Calculate Final Mapping</button>
            <button class="reset-btn" onclick="resetTable()">Reset Table</button>
            <button class="next-btn" onclick="newfile()">Next Page</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializeInputs();
            await fetchAndDisplayData();
        });

        function initializeInputs() {
            const inputs = document.querySelectorAll('input[type="text"]');
            inputs.forEach(input => {
                input.addEventListener('change', updateAttainment);
            });
        }

        function updateAttainment(event) {
            const input = event.target;
            const row = input.closest('tr');
            const percentage = parseFloat(input.value) || 0;
            const attainmentCell = row.cells[2].querySelector('input');
            const caption = input.closest('table').querySelector('caption').textContent;
            const attainmentLevel = getAttainmentLevel(percentage, caption);
            attainmentCell.value = attainmentLevel;
        }

        function getAttainmentLevel(percentage, context) {
            if (context.includes('CES')) {
                if (percentage >= 85) return 3;
                if (percentage >= 80) return 2;
                return 1;
            } else {
                if (percentage >= 75) return 3;
                if (percentage >= 50) return 2;
                return 1;
            }
        }

        async function fetchAndDisplayData() {
            try {
                const [directResponse, indirectResponse] = await Promise.all([
                    fetch('/get_direct_summary'),
                    fetch('/get_indirect_summary')
                ]);
                const directData = await directResponse.json();
                const indirectData = await indirectResponse.json();

                if (directData.perc1 && directData.perc2 && indirectData.wtAvgCO1) {
                    fetchAttainmentData(directData);
                    fetchIndirectData(indirectData);
                    displayInitialAttainment(directData, indirectData);
                } else {
                    console.warn('Incomplete data received from backend');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        async function fetchAttainmentData(data) {
            if (data.perc1 && data.perc2 && !isNaN(data.perc1) && !isNaN(data.perc2)) {
                const tables = document.querySelectorAll('table');
                const seeTable = tables[1]; // Second table (SEE)
                const cieTable = tables[2]; // Third table (CIE)
                const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
                courses.forEach((co, index) => {
                    seeTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input').value = data.perc1;
                    cieTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input').value = data.perc2;
                    updateAttainment({ target: seeTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input') });
                    updateAttainment({ target: cieTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input') });
                });
            }
        }

        async function fetchIndirectData(data) {
            if (data.wtAvgCO1 && !isNaN(data.wtAvgCO1)) {
                const tables = document.querySelectorAll('table');
                const cesTable = tables[3]; // Fourth table (CES)
                const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
                courses.forEach((co, index) => {
                    cesTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input').value = data[`wtAvgCO${index + 1}`];
                    updateAttainment({ target: cesTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input') });
                });
            }
        }

        function displayInitialAttainment(directData, indirectData) {
            const totalExtPercentage = parseFloat(directData.perc1) || 0;
            const totalIntPercentage = parseFloat(directData.perc2) || 0;
            const wtAvgPercentages = {
                co1: parseFloat(indirectData.wtAvgCO1) || 0,
                co2: parseFloat(indirectData.wtAvgCO2) || 0,
                co3: parseFloat(indirectData.wtAvgCO3) || 0,
                co4: parseFloat(indirectData.wtAvgCO4) || 0,
                co5: parseFloat(indirectData.wtAvgCO5) || 0,
                co6: parseFloat(indirectData.wtAvgCO6) || 0
            };

            const mappings = {
                'CSC305.1': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co1 },
                'CSC305.2': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co2 },
                'CSC305.3': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co3 },
                'CSC305.4': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co4 },
                'CSC305.5': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co5 },
                'CSC305.6': { totalExt: totalExtPercentage, totalInt: totalIntPercentage, wtAvg: wtAvgPercentages.co6 }
            };

            Object.keys(mappings).forEach(co => {
                const totalExtAttn = getAttainmentLevel(mappings[co].totalExt, 'SEE');
                const totalIntAttn = getAttainmentLevel(mappings[co].totalInt, 'CIE');
                const wtAvgAttn = getAttainmentLevel(mappings[co].wtAvg, 'CES');

                document.getElementById(`totalExt${co}`).textContent = `${mappings[co].totalExt.toFixed(2)}% (${totalExtAttn})`;
                document.getElementById(`totalExt${co}`).className = `attainment-${totalExtAttn}`;
                document.getElementById(`totalInt${co}`).textContent = `${mappings[co].totalInt.toFixed(2)}% (${totalIntAttn})`;
                document.getElementById(`totalInt${co}`).className = `attainment-${totalIntAttn}`;
                document.getElementById(`wtAvg${co}`).textContent = `${mappings[co].wtAvg.toFixed(2)}% (${wtAvgAttn})`;
                document.getElementById(`wtAvg${co}`).className = `attainment-${wtAvgAttn}`;
            });
        }

        function calculateFinalAttainment() {
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
            const tables = document.querySelectorAll('table');
            const seeTable = tables[1]; // SEE
            const cieTable = tables[2]; // CIE
            const cesTable = tables[3]; // CES

            courses.forEach(co => {
                const seeRow = Array.from(seeTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);
                const cieRow = Array.from(cieTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);
                const cesRow = Array.from(cesTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);

                const seeAttn = parseFloat(seeRow.cells[2].querySelector('input').value) || 0;
                const cieAttn = parseFloat(cieRow.cells[2].querySelector('input').value) || 0;
                const cesAttn = parseFloat(cesRow.cells[2].querySelector('input').value) || 0;

                const directComponent = 0.8 * seeAttn + 0.2 * cieAttn;
                const finalAttn = 0.9 * directComponent + 0.1 * cesAttn;
                const finalCell = document.getElementById(`final${co}`);

                finalCell.textContent = finalAttn.toFixed(2);
                finalCell.className = 'final-attainment';
                if (finalAttn >= 2.5) finalCell.classList.add('attainment-3');
                else if (finalAttn >= 1.5) finalCell.classList.add('attainment-2');
                else finalCell.classList.add('attainment-1');
            });
            alert("Final Attainment Calculated Successfully!");
        }

        function resetTable() {
            const inputs = document.querySelectorAll('input[type="text"]');
            inputs.forEach(input => input.value = '');

            const cells = document.querySelectorAll('#attainmentTable td');
            cells.forEach(cell => {
                cell.textContent = '-';
                cell.className = '';
            });

            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
            courses.forEach(co => {
                document.getElementById(`final${co}`).className = 'final-attainment';
            });

            alert("Table reset successfully!");
        }

        function newfile() {
            // Redirect to the next page (adjust the URL based on your routes)
            window.location.href = '/newfile'; // Example: Go to direct assessment page
        }
    </script>
</body>
</html>