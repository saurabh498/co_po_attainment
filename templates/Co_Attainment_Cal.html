<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Outcome Attainment Calculation</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            background-color: #f4f4f9;
            margin: 0;
            padding: 0;
        }

        h2 {
            color: #333;
            margin-top: 20px;
        }

        .container {
            width: 90%;
            max-width: 900px;
            background: white;
            padding: 20px;
            margin: 20px auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: center;
        }

        th {
            background-color: #007bff;
            color: white;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #e8f0ff;
        }

        .buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calculate-btn {
            background: #28a745;
            color: white;
        }

        .reset-btn {
            background: #dc3545;
            color: white;
        }

        .save-btn {
            background: #17a2b8;
            color: white;
        }

        .next-btn {
            background: #007bff;
            color: white;
        }

        button:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .attainment-3 {
            background-color: #28a745;
            color: white;
        }

        .attainment-2 {
            background-color: #ffc107;
            color: black;
        }

        .attainment-1 {
            background-color: #dc3545;
            color: white;
        }

        .final-attainment {
            font-weight: bold;
        }

        .table-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin: 20px 0;
        }

        input[type="text"] {
            width: 60px;
            padding: 5px;
            text-align: center;
        }
    </style>
</head>

<body>
    <div class="container">
        <table>
            <h2>Course Outcome Attainment Calculation</h2>
            <caption>A. Level of Attainments</caption>
            <thead>
                <tr>
                    <th rowspan="2">Level</th>
                    <th colspan="2">SEE (%)</th>
                    <th colspan="2">CIE (%)</th>
                    <th colspan="2">CES</th>
                </tr>
                <tr>
                    <th class="highlight">></th>
                    <th class="highlight">
                        <=< /th>
                    <th class="highlight">></th>
                    <th class="highlight">
                        <=< /th>
                    <th class="highlight">></th>
                    <th class="highlight">
                        <=< /th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td class="highlight">1</td>
                    <td class="highlight">10</td>
                    <td class="highlight">49</td>
                    <td class="highlight">10</td>
                    <td class="highlight">49</td>
                    <td class="highlight">75</td>
                    <td class="highlight">80</td>
                </tr>
                <tr>
                    <td class="highlight">2</td>
                    <td class="highlight">50</td>
                    <td class="highlight">74</td>
                    <td class="highlight">50</td>
                    <td class="highlight">74</td>
                    <td class="highlight">80</td>
                    <td class="highlight">85</td>
                </tr>
                <tr>
                    <td class="highlight">3</td>
                    <td class="highlight">75</td>
                    <td class="highlight">100</td>
                    <td class="highlight">75</td>
                    <td class="highlight">100</td>
                    <td class="highlight">85</td>
                    <td class="highlight">100</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="container">
        <table>
            <h3>B. Direct / Indirect Attainment Calculation by SEE, CIE and CES</h3>
            <caption>SEE (Direct Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>SEE (%)</th>
                <th>Atn (X)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
        </table>

        <table>
            <caption>CIE (Direct Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>UT AVG</th>
                <th>Atn (Y)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
        </table>

        <table>
            <caption>CES (Indirect Attainment)</caption>
            <tr>
                <th>Course</th>
                <th>AVG</th>
                <th>Atn (Z)</th>
            </tr>
            <tr>
                <td>CSC305.1</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.2</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.3</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.4</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.5</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
            <tr>
                <td>CSC305.6</td>
                <td><input type="text" readonly /></td>
                <td><input type="text" readonly /></td>
            </tr>
        </table>
    </div>

    <div class="container">
        <table id="attainmentTable">
            <caption>D. Final Course Outcome Attainment Calculation: 0.9(0.8X+0.2Y)+0.1(Z)</caption>
            <thead>
                <tr>
                    <th>Course Outcome</th>
                    <th>Total Ext (%)<br>Attainment</th>
                    <th>Total Int (%)<br>Attainment</th>
                    <th>Wt.Avg Max Percentage (%)<br>Attainment</th>
                    <th>Final Attainment</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>CSC305.1</td>
                    <td id="totalExtCSC305.1">-</td>
                    <td id="totalIntCSC305.1">-</td>
                    <td id="wtAvgCSC305.1">-</td>
                    <td id="finalCSC305.1" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.2</td>
                    <td id="totalExtCSC305.2">-</td>
                    <td id="totalIntCSC305.2">-</td>
                    <td id="wtAvgCSC305.2">-</td>
                    <td id="finalCSC305.2" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.3</td>
                    <td id="totalExtCSC305.3">-</td>
                    <td id="totalIntCSC305.3">-</td>
                    <td id="wtAvgCSC305.3">-</td>
                    <td id="finalCSC305.3" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.4</td>
                    <td id="totalExtCSC305.4">-</td>
                    <td id="totalIntCSC305.4">-</td>
                    <td id="wtAvgCSC305.4">-</td>
                    <td id="finalCSC305.4" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.5</td>
                    <td id="totalExtCSC305.5">-</td>
                    <td id="totalIntCSC305.5">-</td>
                    <td id="wtAvgCSC305.5">-</td>
                    <td id="finalCSC305.5" class="final-attainment">-</td>
                </tr>
                <tr>
                    <td>CSC305.6</td>
                    <td id="totalExtCSC305.6">-</td>
                    <td id="totalIntCSC305.6">-</td>
                    <td id="wtAvgCSC305.6">-</td>
                    <td id="finalCSC305.6" class="final-attainment">-</td>
                </tr>
            </tbody>
        </table>

        <div class="buttons">
            <button class="calculate-btn" onclick="calculateFinalAttainment()">Calculate Final Mapping</button>
            <button class="reset-btn" onclick="resetTable()">Reset Table</button>
            <button class="save-btn" onclick="save()">Save</button>
            <button class="next-btn" onclick="co_achievement()">Next Page</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            initializeInputs();
            await fetchAndDisplayData();
        });

        function initializeInputs() {
            const inputs = document.querySelectorAll('input[type="text"]:not([readonly])');
            inputs.forEach(input => {
                input.addEventListener('change', updateAttainment);
            });
        }

        function updateAttainment(event) {
            const input = event.target;
            const row = input.closest('tr');
            const percentage = parseFloat(input.value) || 0;
            const attainmentCell = row.cells[2].querySelector('input');
            const caption = input.closest('table').querySelector('caption').textContent;
            const attainmentLevel = getAttainmentLevel(percentage, caption);
            attainmentCell.value = attainmentLevel;
        }

        function getAttainmentLevel(percentage, context) {
            if (context.includes('CES')) {
                if (percentage >= 85) return 3;
                if (percentage >= 80) return 2;
                return 1;
            } else {
                if (percentage >= 75) return 3;
                if (percentage >= 50) return 2;
                return 1;
            }
        }

        async function fetchAndDisplayData() {
            try {
                const [summaryResponse, utAvgResponse, indirectResponse] = await Promise.all([
                    fetch('http://127.0.0.1:5000/get_summary').then(res => {
                        console.log('Summary Response Status:', res.status, res.statusText);
                        return res.text().then(text => ({ res, text }));
                    }),
                    fetch('http://127.0.0.1:5000/get_avg_ut_co').then(res => {
                        console.log('UT Avg Response Status:', res.status, res.statusText);
                        return res.text().then(text => ({ res, text }));
                    }),
                    fetch('http://127.0.0.1:5000/get_indirect').then(res => {
                        console.log('Indirect Response Status:', res.status, res.statusText);
                        return res.text().then(text => ({ res, text }));
                    })
                ]);

                // Parse JSON manually and log raw text if parsing fails
                let summaryData, utAvgData, indirectData;
                try {
                    summaryData = JSON.parse(summaryResponse.text);
                } catch (e) {
                    console.error('Summary Parse Error:', e, 'Raw Response:', summaryResponse.text);
                    throw e;
                }
                try {
                    utAvgData = JSON.parse(utAvgResponse.text);
                } catch (e) {
                    console.error('UT Avg Parse Error:', e, 'Raw Response:', utAvgResponse.text);
                    throw e;
                }
                try {
                    indirectData = JSON.parse(indirectResponse.text);
                } catch (e) {
                    console.error('Indirect Parse Error:', e, 'Raw Response:', indirectResponse.text);
                    throw e;
                }

                if (summaryData.total_ext_percentage && utAvgData && indirectData.wt_avg_co1) {
                    populateSEETable(summaryData);
                    populateCIETable(utAvgData);
                    populateCESTable(indirectData);
                    updateFinalAttainmentTable(summaryData, utAvgData, indirectData);
                } else {
                    console.warn('Incomplete data received from backend:', {
                        summary: summaryData,
                        utAvg: utAvgData,
                        indirect: indirectData
                    });
                    alert('Failed to load some data. Please ensure all assessments are completed.');
                }
            } catch (error) {
                console.error('Error fetching data:', error);
                alert('Error loading data: ' + error.message);
            }
        }

        function populateSEETable(data) {
            const tables = document.querySelectorAll('table');
            const seeTable = tables[1]; // SEE table
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
            const seeValue = parseFloat(data.total_ext_percentage) || 0;

            courses.forEach((co, index) => {
                const input = seeTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input');
                input.value = seeValue.toFixed(2);
                updateAttainment({ target: input });
            });
        }

        function populateCIETable(data) {
            const tables = document.querySelectorAll('table');
            const cieTable = tables[2]; // CIE table
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];

            courses.forEach((co, index) => {
                const coKey = `CO${index + 1}`.toLowerCase();
                const utAvgValue = parseFloat(data[coKey]?.perc) || 0;
                const input = cieTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input');
                input.value = utAvgValue.toFixed(2);
                updateAttainment({ target: input });
            });
        }

        function populateCESTable(data) {
            const tables = document.querySelectorAll('table');
            const cesTable = tables[3]; // CES table
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];

            courses.forEach((co, index) => {
                const cesValue = parseFloat(data[`wt_avg_co${index + 1}`]) || 0;
                const input = cesTable.querySelectorAll('tr')[index + 1].cells[1].querySelector('input');
                input.value = cesValue.toFixed(2);
                updateAttainment({ target: input });
            });
        }

        function updateFinalAttainmentTable(summaryData, utAvgData, indirectData) {
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];

            courses.forEach((co, index) => {
                const seePercentage = parseFloat(summaryData.total_ext_percentage) || 0;
                const coKey = `CO${index + 1}`.toLowerCase();
                const ciePercentage = parseFloat(utAvgData[coKey]?.perc) || 0;
                const cesPercentage = parseFloat(indirectData[`wt_avg_co${index + 1}`]) || 0;

                const seeAttn = getAttainmentLevel(seePercentage, 'SEE');
                const cieAttn = getAttainmentLevel(ciePercentage, 'CIE');
                const cesAttn = getAttainmentLevel(cesPercentage, 'CES');

                document.getElementById(`totalExt${co}`).textContent = `${seePercentage.toFixed(2)}% (${seeAttn})`;
                document.getElementById(`totalExt${co}`).className = `attainment-${seeAttn}`;
                document.getElementById(`totalInt${co}`).textContent = `${ciePercentage.toFixed(2)}% (${cieAttn})`;
                document.getElementById(`totalInt${co}`).className = `attainment-${cieAttn}`;
                document.getElementById(`wtAvg${co}`).textContent = `${cesPercentage.toFixed(2)}% (${cesAttn})`;
                document.getElementById(`wtAvg${co}`).className = `attainment-${cesAttn}`;
            });
        }

        function save() {
            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
            const tables = document.querySelectorAll('table');
            const seeTable = tables[1];
            const cieTable = tables[2];
            const cesTable = tables[3];

            const savePromises = courses.map(co => {
                const seeRow = Array.from(seeTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);
                const cieRow = Array.from(cieTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);
                const cesRow = Array.from(cesTable.querySelectorAll('tr')).find(row => row.cells[0].textContent === co);

                const data = {
                    course: co,
                    see_percentage: parseFloat(seeRow.cells[1].querySelector('input').value) || 0,
                    cie_ut_avg: parseFloat(cieRow.cells[1].querySelector('input').value) || 0,
                    ces_avg: parseFloat(cesRow.cells[1].querySelector('input').value) || 0
                };

                return fetch('http://127.0.0.1:5000/save_attainment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                })
                    .then(response => {
                        if (!response.ok) throw new Error(`Save failed for ${co}: ${response.status}`);
                        return response.json();
                    })
                    .then(result => {
                        console.log(`Saved ${co}:`, result);
                        return result;
                    })
                    .catch(error => {
                        console.error(`Error saving ${co}:`, error);
                        return { error: error.message };
                    });
            });

            return Promise.all(savePromises)
                .then(results => {
                    const errors = results.filter(r => r.error);
                    if (errors.length > 0) {
                        alert('Some data failed to save: ' + errors.map(e => e.error).join(', '));
                    } else {
                        alert('All data saved successfully!');
                    }
                    return results;
                })
                .catch(error => {
                    console.error('Error during save:', error);
                    alert('Failed to save data: ' + error.message);
                    throw error;
                });
        }

        function calculateFinalAttainment() {
    save().then(() => {
        fetch('http://127.0.0.1:5000/get_final_attainment')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    alert('Error: ' + data.error);
                    return;
                }
                const attainments = data.attainments || {};
                const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];

                courses.forEach(co => {
                    let finalAttn = attainments[co] || 0;
                    // Cap final attainment at 2.20
                    finalAttn = Math.min(finalAttn, 2.20);
                    const finalCell = document.getElementById(`final${co}`);
                    finalCell.textContent = finalAttn.toFixed(2);
                    finalCell.className = 'final-attainment';
                    if (finalAttn >= 2.5) finalCell.classList.add('attainment-3');
                    else if (finalAttn >= 1.5) finalCell.classList.add('attainment-2');
                    else finalCell.classList.add('attainment-1');
                });
                alert("Final Attainment Calculated Successfully!");
            })
            .catch(error => {
                console.error('Error fetching final attainment:', error);
                alert('Failed to calculate final attainment: ' + error.message);
            });
    }).catch(error => {
        console.error('Save failed before calculating:', error);
    });
}

        function resetTable() {
            const inputs = document.querySelectorAll('input[type="text"]');
            inputs.forEach(input => input.value = '');

            const cells = document.querySelectorAll('#attainmentTable td');
            cells.forEach(cell => {
                cell.textContent = '-';
                cell.className = '';
            });

            const courses = ['CSC305.1', 'CSC305.2', 'CSC305.3', 'CSC305.4', 'CSC305.5', 'CSC305.6'];
            courses.forEach(co => {
                document.getElementById(`final${co}`).className = 'final-attainment';
            });

            alert("Table reset successfully!");
        }

        function co_achievement() {
            window.location.href = '/co_achievement';
        }
    </script>
</body>

</html>